## Урок 1. Основы Terraform

#### Д/з:
Цель:
* реализовать терраформ для разворачивания одной виртуалки в yandex-cloud
* запровиженить nginx с помощью ansible

Для сдачи:
* репозиторий с терраформ манифестами
* README файл
#### Pre-requisites
В ~/.ssh/ должен быть ключ, тип не важен.
#### Проблемы и их решение, в порядке возникновения
1. Чтобы приватная подсеть создавалась в сети default, её network_id получается через data_source "yandex_vpc_network".
2. ID образа получается в data_source "yandex_compute_image" по запросу family="centos-stream-8".
3. Inventory для Ansible создаётся в local_file "inventory".
4. Как переменные определены hostname и сервисный логин. С выпуском нового образа в ноябре 2022 логин сменился с centos на cloud-user. Было бы удобно, если бы data_source определял сервисную УЗ, но увы.
5. Чтобы избежать вопроса про незнакомый хост, в inventory добавлен ключ ansible_ssh_common_args='-o StrictHostKeyChecking=no'.
6. Для обработки непостоянства сервисной учётки плейбук для провижена nginx формируется из шаблона с помощью templatefile().
7. Ansible вначале запускался через local_exec изнутри создания виртуалки, но старт sshd не гарантирован даже на момент окончания создания ресурса, из-за чего ansible-playbook завершался ошибкой, а вслед за ним и весь apply. Поэтому выполнение плейбука вынесено в отдельный ресурс null_resource, строго после создания inventory. А старт sshd гарантируется с помощью remote_exec.
8. В remote_exec скармливается private_key (т.к. вход по паролю в этом образе по умолчанию закрыт в sshd_config) из ~/.ssh/. Тип ключа роли не играет - главное, чтобы был какой-нибудь - за это отвечает data_source local_file "public_key".
